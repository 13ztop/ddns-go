name: Safe Sync ddns-go

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  GITHUB_WORKSPACE: ${{ github.workspace }}

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    # 1. å‡†å¤‡å·¥ä½œåŒº
    - name: Prepare workspace
      run: |
        echo "ğŸ› ï¸ åˆå§‹åŒ–å·¥ä½œåŒº..."
        rm -rf target-repo source-repo
        mkdir -p target-repo source-repo
        ls -la  # è°ƒè¯•ç›®å½•ç»“æ„
        
    # 2. å…‹éš†æºä»“åº“
    - name: Clone source repository
      run: |
        echo "â¬‡ï¸ å…‹éš†æºä»“åº“..."
        git clone --depth=1 https://github.com/474706852/ddns-go.git source-repo
        echo "æºä»“åº“å†…å®¹:"
        ls -la source-repo | head -5
        
    # 3. å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆå¸¦è¯¦ç»†è°ƒè¯•ï¼‰
    - name: Clone target repository
      run: |
        echo "â¬‡ï¸ å…‹éš†ç›®æ ‡ä»“åº“..."
        set -x  # å¼€å¯å‘½ä»¤å›æ˜¾
        git clone "https://${{ github.actor }}:${{ secrets.SYNC_TOKEN }}@github.com/13ztop/ddns-go.git" target-repo
        set +x
        
        echo "ç›®æ ‡ä»“åº“.gitçŠ¶æ€:"
        ls -la target-repo/.git
        
    # 4. å®‰å…¨åŒæ­¥ï¼ˆä¿ç•™.gitç›®å½•ï¼‰
    - name: Sync repositories
      run: |
        echo "ğŸ”„ åŒæ­¥æ–‡ä»¶..."
        rsync -av --delete \
          --exclude='/.git' \
          --exclude='/.github/workflows' \
          source-repo/ target-repo/
        
        echo "åŒæ­¥åç›®æ ‡ä»“åº“å†…å®¹:"
        ls -la target-repo | head -5
        
    # 5. é…ç½®Gitç”¨æˆ·
    - name: Configure Git
      run: |
        cd target-repo
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git config --list  # æ˜¾ç¤ºé…ç½®
        
    # 6. å¼ºåˆ¶å˜æ›´æ£€æµ‹
    - name: Check changes
      id: check_changes
      run: |
        cd target-repo
        
        # ç¡®ä¿åœ¨Gitä»“åº“ä¸­
        if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
          echo "::error::âŒ é”™è¯¯ï¼šä¸åœ¨Gitä»“åº“ä¸­"
          exit 1
        fi
        
        # å¼ºåˆ¶æ£€æµ‹æ‰€æœ‰å˜æ›´
        git add -A
        git status
        
        # æ£€æŸ¥çœŸå®å˜æ›´ï¼ˆæ’é™¤.gitignoreï¼‰
        if [ -n "$(git diff --cached --name-only)" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ æ£€æµ‹åˆ°å˜æ›´ï¼"
          
          # ä¿å­˜å˜æ›´æ–‡ä»¶åˆ—è¡¨
          git diff --cached --name-only > $GITHUB_WORKSPACE/changed_files.txt
          echo "å˜æ›´æ–‡ä»¶:"
          cat $GITHUB_WORKSPACE/changed_files.txt
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ğŸŸ¢ æ— å˜æ›´æ£€æµ‹"
        fi
        
    # 7. æäº¤å˜æ›´ï¼ˆå¼ºåˆ¶æ·»åŠ ï¼‰
    - name: Commit changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        cd target-repo
        echo "ğŸ’¾ æäº¤å˜æ›´..."
        
        # è¯»å–å˜æ›´æ–‡ä»¶åˆ—è¡¨
        changed_files=$(cat $GITHUB_WORKSPACE/changed_files.txt | tr '\n' ',')
        
        # åˆ›å»ºæäº¤æ¶ˆæ¯
        commit_msg="å®‰å…¨åŒæ­¥: $(date -u +'%Y-%m-%d %H:%M UTC')"
        commit_msg+="\n\nå˜æ›´æ–‡ä»¶: ${changed_files%,}"
        
        # æäº¤å˜æ›´
        git commit -m "$commit_msg"
        git log -1 --oneline  # æ˜¾ç¤ºæœ€æ–°æäº¤
        
    # 8. å¼ºåˆ¶æ¨é€ï¼ˆå¸¦è¯¦ç»†è¾“å‡ºï¼‰
    - name: Push changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        cd target-repo
        echo "ğŸš€ æ¨é€å˜æ›´..."
        
        # æ˜¾ç¤ºè¿œç¨‹ä¿¡æ¯
        git remote -v
        
        # å¼ºåˆ¶æ¨é€
        set -x
        git push origin main
        set +x
        
        echo "âœ… æ¨é€æˆåŠŸï¼"
        
    # 9. Telegramé€šçŸ¥ï¼ˆç®€åŒ–ç‰ˆï¼‰
    - name: Send Telegram notification
      if: always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
      run: |
        # åŸºç¡€æ¶ˆæ¯
        status="ğŸŸ¢ åŒæ­¥å®Œæˆ"
        if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
          status="ğŸš€ å·²æ¨é€å˜æ›´"
        fi
        
        # åˆ›å»ºæ¶ˆæ¯
        message="*ddns-go åŒæ­¥æŠ¥å‘Š*%0A%0A${status}%0A%0A"
        message+="ğŸ•’ æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M UTC')%0A"
        message+="ğŸ”— [å·¥ä½œæµè¯¦æƒ…]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)"
        
        # å‘é€é€šçŸ¥
        curl -s -X POST \
          "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -d "chat_id=$TELEGRAM_CHAT_ID" \
          -d "text=$message" \
          -d "parse_mode=Markdown"
        
        echo "ğŸ“¨ Telegramé€šçŸ¥å·²å‘é€"
