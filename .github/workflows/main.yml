name: Safe Sync ddns-go

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  GITHUB_WORKSPACE: ${{ github.workspace }}
  REPO_URL: "https://github.com/13ztop/ddns-go"  # ç›®æ ‡ä»“åº“URL

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    # 1. å‡†å¤‡å·¥ä½œåŒº
    - name: Prepare workspace
      run: |
        rm -rf target-repo source-repo
        mkdir -p target-repo source-repo
        
    # 2. å…‹éš†æºä»“åº“
    - name: Clone source repository
      run: |
        git clone --depth=1 https://github.com/474706852/ddns-go.git source-repo
        
    # 3. å…‹éš†ç›®æ ‡ä»“åº“
    - name: Clone target repository
      run: |
        git clone "https://${{ github.actor }}:${{ secrets.SYNC_TOKEN }}@github.com/13ztop/ddns-go.git" target-repo
        
    # 4. å®‰å…¨åŒæ­¥ï¼ˆä¿ç•™.gitç›®å½•ï¼‰
    - name: Sync repositories
      run: |
        rsync -a --delete \
          --exclude='/.git' \
          --exclude='/.github/workflows' \
          source-repo/ target-repo/
        
    # 5. é…ç½®Gitç”¨æˆ·
    - name: Configure Git
      run: |
        cd target-repo
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
    # 6. è¯¦ç»†å˜æ›´æ£€æµ‹
    - name: Detect changes
      id: detect_changes
      run: |
        cd target-repo
        
        # è·å–å˜æ›´çŠ¶æ€ï¼ˆæŒ‰ç±»å‹åˆ†ç±»ï¼‰
        git add -A
        changes=$(git status --porcelain)
        
        if [ -z "$changes" ]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ğŸŸ¢ æ— å˜æ›´æ£€æµ‹"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # åˆ†ç±»å˜æ›´
          added_files=$(echo "$changes" | grep '^A' | cut -c4-)
          modified_files=$(echo "$changes" | grep '^ M' | cut -c4-)
          deleted_files=$(echo "$changes" | grep '^ D' | cut -c4-)
          
          # ä¿å­˜å˜æ›´åˆ—è¡¨
          echo "$changes" | cut -c4- > $GITHUB_WORKSPACE/all_changed_files.txt
          
          # ä¿å­˜å„ç±»å˜æ›´
          echo "$added_files" > $GITHUB_WORKSPACE/added_files.txt
          echo "$modified_files" > $GITHUB_WORKSPACE/modified_files.txt
          echo "$deleted_files" > $GITHUB_WORKSPACE/deleted_files.txt
          
          # è¾“å‡ºç»Ÿè®¡
          echo "ğŸ“ å˜æ›´ç»Ÿè®¡:"
          echo "  â• æ–°å¢: $(echo "$added_files" | wc -l)"
          echo "  âœï¸ ä¿®æ”¹: $(echo "$modified_files" | wc -l)"
          echo "  âŒ åˆ é™¤: $(echo "$deleted_files" | wc -l)"
        fi
        
    # 7. ç”Ÿæˆè¯¦ç»†æäº¤ä¿¡æ¯
    - name: Prepare commit message
      id: prepare_commit
      if: steps.detect_changes.outputs.has_changes == 'true'
      run: |
        # è¯»å–å„ç±»å˜æ›´æ–‡ä»¶
        added_files=$(cat $GITHUB_WORKSPACE/added_files.txt)
        modified_files=$(cat $GITHUB_WORKSPACE/modified_files.txt)
        deleted_files=$(cat $GITHUB_WORKSPACE/deleted_files.txt)
        
        # ç”ŸæˆMarkdownæ ¼å¼çš„æäº¤ä¿¡æ¯
        commit_msg="å®‰å…¨åŒæ­¥: $(date -u +'%Y-%m-%d %H:%M UTC')\n\n"
        
        if [ -n "$added_files" ]; then
          commit_msg+="### â• æ–°å¢æ–‡ä»¶\n"
          commit_msg+="$(echo "$added_files" | sed 's/^/- /')\n\n"
        fi
        
        if [ -n "$modified_files" ]; then
          commit_msg+="### âœï¸ ä¿®æ”¹æ–‡ä»¶\n"
          commit_msg+="$(echo "$modified_files" | sed 's/^/- /')\n\n"
        fi
        
        if [ -n "$deleted_files" ]; then
          commit_msg+="### âŒ åˆ é™¤æ–‡ä»¶\n"
          commit_msg+="$(echo "$deleted_files" | sed 's/^/- /')\n\n"
        fi
        
        # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
        echo "COMMIT_MSG<<EOF" >> $GITHUB_ENV
        echo -e "$commit_msg" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
        # æ˜¾ç¤ºé¢„è§ˆ
        echo "ğŸ“ æäº¤ä¿¡æ¯é¢„è§ˆ:"
        echo -e "$commit_msg"
        
    # 8. æäº¤å˜æ›´
    - name: Commit changes
      if: steps.detect_changes.outputs.has_changes == 'true'
      run: |
        cd target-repo
        git add -A
        git commit -m "$(echo -e "${{ env.COMMIT_MSG }}" | head -n 1)" -m "$(echo -e "${{ env.COMMIT_MSG }}" | tail -n +2)"
        echo "ğŸ’¾ å˜æ›´å·²æäº¤"
        
    # 9. æ¨é€å˜æ›´
    - name: Push changes
      if: steps.detect_changes.outputs.has_changes == 'true'
      run: |
        cd target-repo
        git push origin main
        echo "ğŸš€ å˜æ›´å·²æ¨é€"
        
    # 10. è¯¦ç»†Telegramé€šçŸ¥ï¼ˆå¸¦æ–‡ä»¶é“¾æ¥ï¼‰
    - name: Send detailed Telegram notification
      if: always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
      run: |
        # åŸºç¡€æ¶ˆæ¯
        status="ğŸŸ¢ *æ— å˜æ›´*"
        if [ "${{ steps.detect_changes.outputs.has_changes }}" = "true" ]; then
          status="ğŸš€ *åŒæ­¥å®Œæˆ*"
        fi
        
        # è¯»å–å˜æ›´æ–‡ä»¶
        added_files=$(cat $GITHUB_WORKSPACE/added_files.txt 2>/dev/null || true)
        modified_files=$(cat $GITHUB_WORKSPACE/modified_files.txt 2>/dev/null || true)
        deleted_files=$(cat $GITHUB_WORKSPACE/deleted_files.txt 2>/dev/null || true)
        
        # ç”ŸæˆMarkdownæ ¼å¼çš„æ¶ˆæ¯
        message="*ddns-go å®‰å…¨åŒæ­¥æŠ¥å‘Š*%0A%0A"
        message+="$status%0A"
        message+="ğŸ•’ æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M UTC')%0A"
        message+="ğŸ”— [å·¥ä½œæµè¯¦æƒ…]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)%0A%0A"
        
        # ç”Ÿæˆæ–‡ä»¶é“¾æ¥å‡½æ•°
        generate_file_links() {
          local files="$1"
          local change_type="$2"
          
          if [ -z "$files" ]; then
            return
          fi
          
          # æ·»åŠ å˜æ›´æ ‡é¢˜
          case $change_type in
            added) message+="*â• æ–°å¢æ–‡ä»¶:*%0A" ;;
            modified) message+="*âœï¸ ä¿®æ”¹æ–‡ä»¶:*%0A" ;;
            deleted) message+="*âŒ åˆ é™¤æ–‡ä»¶:*%0A" ;;
          esac
          
          # æ·»åŠ æ–‡ä»¶åˆ—è¡¨ï¼ˆæœ€å¤š5ä¸ªï¼‰
          count=0
          echo "$files" | while read -r file; do
            if [ -n "$file" ]; then
              count=$((count+1))
              # ç”ŸæˆGitHubæ–‡ä»¶é“¾æ¥
              file_url="${REPO_URL}/blob/main/${file}"
              
              # å¯¹äºåˆ é™¤æ–‡ä»¶ä½¿ç”¨ä¸åŒæ ¼å¼
              if [ "$change_type" = "deleted" ]; then
                message+="â€¢ ~${file}~%0A"
              else
                message+="â€¢ [${file}]($file_url)%0A"
              fi
              
              # æœ€å¤šæ˜¾ç¤º5ä¸ªæ–‡ä»¶
              if [ $count -ge 5 ]; then
                break
              fi
            fi
          done
          
          # æ·»åŠ æ›´å¤šæ–‡ä»¶æç¤º
          total_count=$(echo "$files" | wc -l)
          if [ $total_count -gt 5 ]; then
            message+="â€¢ ç­‰ $((total_count-5)) ä¸ªæ–‡ä»¶...%0A"
          fi
          message+="%0A"
        }
        
        # æ·»åŠ å„ç±»å˜æ›´
        generate_file_links "$added_files" "added"
        generate_file_links "$modified_files" "modified"
        generate_file_links "$deleted_files" "deleted"
        
        # æ·»åŠ å˜æ›´ç»Ÿè®¡
        if [ "${{ steps.detect_changes.outputs.has_changes }}" = "true" ]; then
          total_changes=$(( $(echo "$added_files" | wc -l) + $(echo "$modified_files" | wc -l) + $(echo "$deleted_files" | wc -l) ))
          message+="*ğŸ“Š å˜æ›´ç»Ÿè®¡:*%0A"
          message+="â€¢ æ–°å¢: $(echo "$added_files" | wc -l)%0A"
          message+="â€¢ ä¿®æ”¹: $(echo "$modified_files" | wc -l)%0A"
          message+="â€¢ åˆ é™¤: $(echo "$deleted_files" | wc -l)%0A"
          message+="â€¢ æ€»è®¡: $total_changes ä¸ªæ–‡ä»¶%0A%0A"
        fi
        
        # å‘é€Telegramé€šçŸ¥
        curl -s -X POST \
          "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -H "Content-Type: application/json" \
          -d '{
            "chat_id": "'"$TELEGRAM_CHAT_ID"'",
            "text": "'"$message"'",
            "parse_mode": "Markdown",
            "disable_web_page_preview": true
          }'
        
        echo "ğŸ“¨ Telegramé€šçŸ¥å·²å‘é€"
