name: Safe Sync ddns-go

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  GITHUB_WORKSPACE: ${{ github.workspace }}
  REPO_URL: "https://github.com/13ztop/ddns-go"

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    # 1. å‡†å¤‡å·¥ä½œåŒº
    - name: Prepare workspace
      run: |
        rm -rf target-repo source-repo
        mkdir -p target-repo source-repo
        
    # 2. å…‹éš†æºä»“åº“
    - name: Clone source repository
      run: |
        git clone --depth=1 https://github.com/474706852/ddns-go.git source-repo
        
    # 3. å…‹éš†ç›®æ ‡ä»“åº“
    - name: Clone target repository
      run: |
        git clone "https://${{ github.actor }}:${{ secrets.SYNC_TOKEN }}@github.com/13ztop/ddns-go.git" target-repo
        
    # 4. å®‰å…¨åŒæ­¥
    - name: Sync repositories
      run: |
        rsync -a --delete \
          --exclude='/.git' \
          --exclude='/.github/workflows' \
          source-repo/ target-repo/
        
    # 5. é…ç½®Gitç”¨æˆ·
    - name: Configure Git
      run: |
        cd target-repo
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
    # 6. å˜æ›´æ£€æµ‹
    - name: Detect changes
      id: detect_changes
      run: |
        cd target-repo
        
        git add -A
        changes=$(git status --porcelain)
        
        if [ -z "$changes" ]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ğŸŸ¢ æ— å˜æ›´æ£€æµ‹"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # åˆ†ç±»å˜æ›´
          added_files=$(echo "$changes" | grep '^A' | cut -c4-)
          modified_files=$(echo "$changes" | grep '^ M' | cut -c4-)
          deleted_files=$(echo "$changes" | grep '^ D' | cut -c4-)
          
          # ä¿å­˜å˜æ›´åˆ—è¡¨
          mkdir -p $GITHUB_WORKSPACE/change_details
          echo "$added_files" > $GITHUB_WORKSPACE/change_details/added_files.txt
          echo "$modified_files" > $GITHUB_WORKSPACE/change_details/modified_files.txt
          echo "$deleted_files" > $GITHUB_WORKSPACE/change_details/deleted_files.txt
        fi
        
    # 7. æäº¤å˜æ›´
    - name: Commit changes
      if: steps.detect_changes.outputs.has_changes == 'true'
      run: |
        cd target-repo
        git add -A
        git commit -m "å®‰å…¨åŒæ­¥: $(date -u +'%Y-%m-%d %H:%M UTC')"
        
    # 8. æ¨é€å˜æ›´
    - name: Push changes
      if: steps.detect_changes.outputs.has_changes == 'true'
      run: |
        cd target-repo
        git push origin main
        
    # 9. ä¿®å¤çš„Telegramé€šçŸ¥
    - name: Send Telegram notification
      if: always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
      run: |
        # è®¾ç½®å­—ç¬¦ç¼–ç 
        export LC_ALL=en_US.UTF-8
        export LANG=en_US.UTF-8
        
        # å·¥ä½œæµè¯¦æƒ…é“¾æ¥
        workflow_url="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        
        # åŸºç¡€æ¶ˆæ¯
        if [ "${{ steps.detect_changes.outputs.has_changes }}" = "true" ]; then
          status="ğŸš€ åŒæ­¥å®Œæˆ"
          # è¯»å–å˜æ›´æ–‡ä»¶
          added_files=$(cat $GITHUB_WORKSPACE/change_details/added_files.txt 2>/dev/null || true)
          modified_files=$(cat $GITHUB_WORKSPACE/change_details/modified_files.txt 2>/dev/null || true)
          deleted_files=$(cat $GITHUB_WORKSPACE/change_details/deleted_files.txt 2>/dev/null || true)
          
          # æ„å»ºå˜æ›´æè¿°
          changes_desc=""
          if [ -n "$added_files" ]; then
            changes_desc+="â• æ–°å¢: $(echo "$added_files" | wc -l)ä¸ªæ–‡ä»¶\n"
          fi
          if [ -n "$modified_files" ]; then
            changes_desc+="âœï¸ ä¿®æ”¹: $(echo "$modified_files" | wc -l)ä¸ªæ–‡ä»¶\n"
          fi
          if [ -n "$deleted_files" ]; then
            changes_desc+="âŒ åˆ é™¤: $(echo "$deleted_files" | wc -l)ä¸ªæ–‡ä»¶\n"
          fi
          
          # æ˜¾ç¤ºå‰3ä¸ªå˜æ›´æ–‡ä»¶
          sample_changes=""
          if [ -n "$added_files" ]; then
            sample_changes+="æ–°å¢:\n$(echo "$added_files" | head -3 | sed 's/^/- /')\n\n"
          fi
          if [ -n "$modified_files" ]; then
            sample_changes+="ä¿®æ”¹:\n$(echo "$modified_files" | head -3 | sed 's/^/- /')\n\n"
          fi
          if [ -n "$deleted_files" ]; then
            sample_changes+="åˆ é™¤:\n$(echo "$deleted_files" | head -3 | sed 's/^/- /')\n\n"
          fi
        else
          status="ğŸŸ¢ æ— å˜æ›´"
          changes_desc=""
          sample_changes=""
        fi
        
        # åˆ›å»ºå®Œæ•´çš„æ¶ˆæ¯
        message="*ğŸ“¦ ddns-go å®‰å…¨åŒæ­¥æŠ¥å‘Š*\n\n"
        message+="${status}\n\n"
        
        if [ -n "$changes_desc" ]; then
          message+="${changes_desc}\n"
        fi
        
        message+="ğŸ•’ æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M UTC')\n"
        message+="ğŸ”— [å·¥ä½œæµè¯¦æƒ…]($workflow_url)\n"
        
        if [ -n "$sample_changes" ]; then
          message+="\n*å˜æ›´ç¤ºä¾‹:*\n"
          message+="${sample_changes}"
        fi
        
        # ä½¿ç”¨printfæ­£ç¡®æ ¼å¼åŒ–æ¶ˆæ¯
        formatted_message=$(printf "%b" "$message")
        
        # åˆ›å»ºJSONæ•°æ®
        json_data=$(jq -n \
          --arg chat_id "$TELEGRAM_CHAT_ID" \
          --arg text "$formatted_message" \
          '{
            chat_id: $chat_id,
            text: $text,
            parse_mode: "Markdown",
            disable_web_page_preview: true
          }')
        
        # ä¿å­˜JSONåˆ°æ–‡ä»¶
        echo "$json_data" > payload.json
        
        # å‘é€é€šçŸ¥
        curl -s -X POST \
          "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -H "Content-Type: application/json" \
          -d "@payload.json"
        
        echo "ğŸ“¨ Telegramé€šçŸ¥å·²å‘é€"
