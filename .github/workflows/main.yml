name: Safe Sync ddns-go

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  GITHUB_WORKSPACE: ${{ github.workspace }}

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    # åˆå§‹åŒ–å·¥ä½œåŒº
    - name: Prepare workspace
      run: |
        rm -rf target-repo source-repo
        mkdir -p target-repo source-repo
        
    # å…‹éš†æºä»“åº“
    - name: Clone source repository
      run: |
        git clone --depth=1 https://github.com/474706852/ddns-go.git source-repo
        
    # å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
    - name: Clone target repository
      run: |
        if ! git clone "https://${{ github.actor }}:${{ secrets.SYNC_TOKEN }}@github.com/13ztop/ddns-go.git" target-repo; then
          echo "::error::æ— æ³•å…‹éš†ç›®æ ‡ä»“åº“"
          exit 1
        fi
        
    # å®‰å…¨åŒæ­¥ï¼ˆä¿ç•™.gitç›®å½•ï¼‰
    - name: Safe sync
      run: |
        # ä½¿ç”¨rsyncä½†æ’é™¤.gitç›®å½•
        rsync -a --delete \
          --exclude='/.git' \
          --exclude='/.github/workflows' \
          source-repo/ target-repo/
        
        # éªŒè¯.gitç›®å½•å­˜åœ¨
        if [ ! -d "target-repo/.git" ]; then
          echo "::error::ç›®æ ‡ä»“åº“.gitç›®å½•ä¸¢å¤±"
          exit 1
        fi
        
    # é…ç½®Gitç”¨æˆ·
    - name: Configure Git
      run: |
        cd target-repo
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
    # æ”¹è¿›çš„å˜æ›´æ£€æµ‹
    - name: Check changes
      id: check_changes
      run: |
        cd target-repo
        
        # ç¡®ä¿åœ¨Gitä»“åº“ä¸­
        if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
          echo "::error::ä¸åœ¨Gitä»“åº“ä¸­"
          exit 1
        fi
        
        # è·å–å˜æ›´çŠ¶æ€
        git add -A
        changes=$(git diff --cached --name-only)
        
        if [ -z "$changes" ]; then
          echo "has_changes=0" >> $GITHUB_OUTPUT
          echo "ğŸŸ¢ æœªæ£€æµ‹åˆ°å˜æ›´"
        else
          echo "has_changes=1" >> $GITHUB_OUTPUT
          echo "ğŸ“ æ£€æµ‹åˆ°å˜æ›´ï¼š"
          echo "$changes" | sed 's/^/â€¢ /'
          # ä¿å­˜å˜æ›´åˆ—è¡¨
          echo "$changes" | tr '\n' ',' > $GITHUB_WORKSPACE/changed_files.txt
        fi
        
    # æäº¤å˜æ›´
    - name: Commit changes
      if: steps.check_changes.outputs.has_changes == '1'
      run: |
        cd target-repo
        git add -A
        git commit -m "å®‰å…¨åŒæ­¥: $(date -u +'%Y-%m-%d %H:%M UTC')"
        
    # æ¨é€å˜æ›´
    - name: Push changes
      if: steps.check_changes.outputs.has_changes == '1'
      run: |
        cd target-repo
        if ! git push origin main; then
          echo "::error::æ¨é€å¤±è´¥"
          exit 1
        fi
        echo "ğŸš€ å˜æ›´å·²æ¨é€"
        
    # Telegramé€šçŸ¥
    - name: Send Telegram notification
      if: always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
      run: |
        # ... [ä¿ç•™åŸæœ‰é€šçŸ¥é€»è¾‘] ...
