name: Safe Sync ddns-go

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹è¿è¡Œ
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  GITHUB_WORKSPACE: ${{ github.workspace }}
  REPO_URL: "https://github.com/13ztop/ddns-go"  # ç›®æ ‡ä»“åº“URL
  SYNC_EXCLUDE: "--exclude='/.git' --exclude='/.github/workflows'"  # åŒæ­¥æ’é™¤é¡¹

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    # 1. åˆå§‹åŒ–å·¥ä½œåŒº
    - name: Prepare workspace
      run: |
        echo "ğŸ› ï¸ åˆå§‹åŒ–å·¥ä½œåŒº..."
        rm -rf target-repo source-repo
        mkdir -p target-repo source-repo
        echo "å·¥ä½œåŒºç›®å½•ç»“æ„:"
        ls -la
        
    # 2. å…‹éš†æºä»“åº“
    - name: Clone source repository
      run: |
        echo "â¬‡ï¸ å…‹éš†æºä»“åº“..."
        git clone --depth=1 https://github.com/474706852/ddns-go.git source-repo
        echo "æºä»“åº“å†…å®¹:"
        ls -la source-repo | head -5
        
    # 3. å…‹éš†ç›®æ ‡ä»“åº“
    - name: Clone target repository
      run: |
        echo "â¬‡ï¸ å…‹éš†ç›®æ ‡ä»“åº“..."
        set -x  # å¼€å¯è¯¦ç»†è¾“å‡º
        git clone "https://${{ github.actor }}:${{ secrets.SYNC_TOKEN }}@github.com/13ztop/ddns-go.git" target-repo
        set +x
        
        echo "ç›®æ ‡ä»“åº“éªŒè¯:"
        ls -la target-repo/.git || echo "âŒ ç›®æ ‡ä»“åº“.gitç›®å½•ä¸å­˜åœ¨"
        
    # 4. å®‰å…¨åŒæ­¥ç›®å½•
    - name: Sync repositories
      run: |
        echo "ğŸ”„ åŒæ­¥æ–‡ä»¶..."
        rsync -a --delete \
          ${{ env.SYNC_EXCLUDE }} \
          source-repo/ target-repo/
        
        echo "åŒæ­¥åç›®æ ‡ä»“åº“å†…å®¹:"
        ls -la target-repo | head -5
        
    # 5. é…ç½®Gitç”¨æˆ·
    - name: Configure Git
      run: |
        cd target-repo
        echo "âš™ï¸ é…ç½®Gitç”¨æˆ·..."
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        echo "å½“å‰Gité…ç½®:"
        git config --list
        
    # 6. å˜æ›´æ£€æµ‹ä¸åˆ†ç±»
    - name: Detect and classify changes
      id: detect_changes
      run: |
        cd target-repo
        
        # éªŒè¯Gitä»“åº“çŠ¶æ€
        if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
          echo "::error::âŒ é”™è¯¯ï¼šä¸åœ¨Gitä»“åº“ä¸­"
          exit 1
        fi
        
        echo "ğŸ” æ£€æµ‹å˜æ›´..."
        # æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ°æš‚å­˜åŒº
        git add -A
        
        # è·å–å˜æ›´çŠ¶æ€
        changes=$(git status --porcelain)
        
        if [ -z "$changes" ]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ğŸŸ¢ æ— å˜æ›´æ£€æµ‹"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # åˆ†ç±»å˜æ›´æ–‡ä»¶
          added_files=$(echo "$changes" | grep '^A' | cut -c4-)
          modified_files=$(echo "$changes" | grep '^ M' | cut -c4-)
          deleted_files=$(echo "$changes" | grep '^ D' | cut -c4-)
          renamed_files=$(echo "$changes" | grep '^R' | cut -c4- | awk '{print $2}')
          
          # ä¿å­˜å˜æ›´åˆ—è¡¨åˆ°æ–‡ä»¶
          mkdir -p $GITHUB_WORKSPACE/change_details
          echo "$added_files" > $GITHUB_WORKSPACE/change_details/added_files.txt
          echo "$modified_files" > $GITHUB_WORKSPACE/change_details/modified_files.txt
          echo "$deleted_files" > $GITHUB_WORKSPACE/change_details/deleted_files.txt
          echo "$renamed_files" > $GITHUB_WORKSPACE/change_details/renamed_files.txt
          
          # è¾“å‡ºç»Ÿè®¡
          echo "ğŸ“Š å˜æ›´ç»Ÿè®¡:"
          echo "  â• æ–°å¢: $(echo "$added_files" | wc -l) æ–‡ä»¶"
          echo "  âœï¸ ä¿®æ”¹: $(echo "$modified_files" | wc -l) æ–‡ä»¶"
          echo "  âŒ åˆ é™¤: $(echo "$deleted_files" | wc -l) æ–‡ä»¶"
          echo "  ğŸ”„ é‡å‘½å: $(echo "$renamed_files" | wc -l) æ–‡ä»¶"
        fi
        
    # 7. æäº¤å˜æ›´
    - name: Commit changes
      if: steps.detect_changes.outputs.has_changes == 'true'
      run: |
        cd target-repo
        echo "ğŸ’¾ æäº¤å˜æ›´..."
        
        # ç”Ÿæˆæäº¤æ¶ˆæ¯
        commit_time=$(date -u +'%Y-%m-%d %H:%M UTC')
        commit_msg="å®‰å…¨åŒæ­¥: $commit_time"
        
        # æäº¤å˜æ›´
        git commit -m "$commit_msg"
        echo "âœ… å·²æäº¤å˜æ›´"
        git log -1 --oneline
        
    # 8. æ¨é€å˜æ›´
    - name: Push changes
      if: steps.detect_changes.outputs.has_changes == 'true'
      run: |
        cd target-repo
        echo "ğŸš€ æ¨é€å˜æ›´åˆ°è¿œç¨‹ä»“åº“..."
        
        # æ˜¾ç¤ºè¿œç¨‹ä¿¡æ¯
        git remote -v
        
        # æ‰§è¡Œæ¨é€
        set -x
        git push origin main
        set +x
        
        echo "âœ… å˜æ›´å·²æˆåŠŸæ¨é€"
        
    # 9. é«˜çº§Telegramé€šçŸ¥
    - name: Send Telegram notification
      if: always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
      run: |
        # è®¾ç½®å­—ç¬¦ç¼–ç 
        export LC_ALL=en_US.UTF-8
        export LANG=en_US.UTF-8
        
        # å·¥ä½œæµè¯¦æƒ…é“¾æ¥
        workflow_url="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        
        # åŸºç¡€æ¶ˆæ¯
        sync_status=""
        changes_summary=""
        changes_sample=""
        
        if [ "${{ steps.detect_changes.outputs.has_changes }}" = "true" ]; then
          sync_status="ğŸš€ *åŒæ­¥å®Œæˆ*"
          
          # è¯»å–å˜æ›´æ–‡ä»¶
          added_files=$(cat $GITHUB_WORKSPACE/change_details/added_files.txt 2>/dev/null || true)
          modified_files=$(cat $GITHUB_WORKSPACE/change_details/modified_files.txt 2>/dev/null || true)
          deleted_files=$(cat $GITHUB_WORKSPACE/change_details/deleted_files.txt 2>/dev/null || true)
          renamed_files=$(cat $GITHUB_WORKSPACE/change_details/renamed_files.txt 2>/dev/null || true)
          
          # å˜æ›´ç»Ÿè®¡
          total_changes=$(( $(echo "$added_files" | wc -l) + $(echo "$modified_files" | wc -l) + $(echo "$deleted_files" | wc -l) + $(echo "$renamed_files" | wc -l) ))
          changes_summary="ğŸ“Š *å˜æ›´ç»Ÿè®¡*%0A"
          changes_summary+="â€¢ â• æ–°å¢: $(echo "$added_files" | wc -l) æ–‡ä»¶%0A"
          changes_summary+="â€¢ âœï¸ ä¿®æ”¹: $(echo "$modified_files" | wc -l) æ–‡ä»¶%0A"
          changes_summary+="â€¢ âŒ åˆ é™¤: $(echo "$deleted_files" | wc -l) æ–‡ä»¶%0A"
          changes_summary+="â€¢ ğŸ”„ é‡å‘½å: $(echo "$renamed_files" | wc -l) æ–‡ä»¶%0A"
          changes_summary+="â€¢ âœ… æ€»è®¡: $total_changes ä¸ªæ–‡ä»¶%0A%0A"
          
          # å˜æ›´ç¤ºä¾‹
          changes_sample="ğŸ” *å˜æ›´ç¤ºä¾‹*%0A"
          if [ -n "$added_files" ]; then
            changes_sample+="â• æ–°å¢:%0A"
            echo "$added_files" | head -2 | while read file; do
              changes_sample+="- [${file}](${{ env.REPO_URL }}/blob/main/${file})%0A"
            done
          fi
          
          if [ -n "$modified_files" ]; then
            changes_sample+="%0Aâœï¸ ä¿®æ”¹:%0A"
            echo "$modified_files" | head -2 | while read file; do
              changes_sample+="- [${file}](${{ env.REPO_URL }}/blob/main/${file})%0A"
            done
          fi
          
          if [ -n "$deleted_files" ]; then
            changes_sample+="%0AâŒ åˆ é™¤:%0A"
            echo "$deleted_files" | head -2 | while read file; do
              changes_sample+="- ~${file}~%0A"
            done
          fi
          
          if [ -n "$renamed_files" ]; then
            changes_sample+="%0AğŸ”„ é‡å‘½å:%0A"
            echo "$renamed_files" | head -2 | while read file; do
              changes_sample+="- ${file}%0A"
            done
          fi
          
          # æ·»åŠ æ›´å¤šæç¤º
          if [ $total_changes -gt 8 ]; then
            changes_sample+="%0Aâ„¹ï¸ åªæ˜¾ç¤ºéƒ¨åˆ†å˜æ›´ï¼ŒæŸ¥çœ‹å…¨éƒ¨è¯·ç‚¹å‡»å·¥ä½œæµè¯¦æƒ…é“¾æ¥"
          fi
        else
          sync_status="ğŸŸ¢ *æ— å˜æ›´*"
        fi
        
        # åˆ›å»ºæ¶ˆæ¯
        message="*ğŸ“¦ ddns-go å®‰å…¨åŒæ­¥æŠ¥å‘Š*%0A%0A"
        message+="${sync_status}%0A%0A"
        message+="ğŸ•’ æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M UTC')%0A"
        message+="ğŸ”— [å·¥ä½œæµè¯¦æƒ…]($workflow_url)%0A%0A"
        
        if [ -n "$changes_summary" ]; then
          message+="${changes_summary}"
        fi
        
        if [ -n "$changes_sample" ]; then
          message+="${changes_sample}"
        fi
        
        # å†™å…¥æ–‡ä»¶é¿å…ç¼–ç é—®é¢˜
        echo -e "$message" > message.txt
        
        # å‘é€é€šçŸ¥
        curl -s -X POST \
          "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -H "Content-Type: application/json" \
          -d @<(jq -n \
            --arg chat_id "$TELEGRAM_CHAT_ID" \
            --rawfile text message.txt \
            '{
              chat_id: $chat_id,
              text: $text,
              parse_mode: "Markdown",
              disable_web_page_preview: true
            }')
        
        echo "ğŸ“¨ Telegramé€šçŸ¥å·²å‘é€"
        
    # 10. æœ€ç»ˆçŠ¶æ€æŠ¥å‘Š
    - name: Final status report
      if: always()
      run: |
        if [ "${{ steps.detect_changes.outputs.has_changes }}" = "true" ]; then
          echo "::notice title=åŒæ­¥æŠ¥å‘Š::ğŸš€ æˆåŠŸæ¨é€å˜æ›´åˆ°ç›®æ ‡ä»“åº“"
        else
          echo "::notice title=åŒæ­¥æŠ¥å‘Š::ğŸŸ¢ æ— å˜æ›´éœ€è¦åŒæ­¥"
        fi
        echo "ğŸ•’ å·¥ä½œæµå®Œæˆæ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
