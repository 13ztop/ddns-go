name: Full Sync ddns-go with Telegram Notify

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è‡ªåŠ¨åŒæ­¥
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout 13ztop/ddns-go
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.SYNC_TOKEN }}
        repository: 13ztop/ddns-go
        path: target-repo
        fetch-depth: 0
        ref: main

    - name: Clone source ddns-go
      run: |
        git clone --depth 1 https://github.com/474706852/ddns-go.git source-repo
        cd source-repo
        git checkout main

    - name: Perform full sync
      run: |
        # ä¿ç•™ç›®æ ‡ä»“åº“çš„.gitç›®å½•
        find target-repo -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
        
        # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬éšè—æ–‡ä»¶ï¼‰
        cp -a source-repo/. target-repo/
        echo "âœ… æ‰€æœ‰æ–‡ä»¶å·²ä»æºä»“åº“åŒæ­¥"

    - name: Check for changes
      id: check-changes
      run: |
        cd target-repo
        if git diff-index --quiet HEAD --; then
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "ğŸŸ¢ æœªæ£€æµ‹åˆ°å˜æ›´"
        else
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "ğŸŸ¡ æ£€æµ‹åˆ°å˜æ›´"
        fi

    - name: Commit changes
      if: steps.check-changes.outputs.changes_detected == 'true'
      run: |
        cd target-repo
        git config user.name "GitHub Actions Sync"
        git config user.email "actions@github.com"
        git add -A
        git commit -m "Auto-sync: Full update from 474706852/ddns-go @ $(date -u +'%Y-%m-%d %H:%M UTC')"
        echo "ğŸ”µ å˜æ›´å·²æäº¤"

    - name: Push changes to 13ztop/ddns-go
      if: steps.check-changes.outputs.changes_detected == 'true'
      run: |
        cd target-repo
        git push origin main
        echo "ğŸš€ å˜æ›´å·²æ¨é€åˆ° 13ztop/ddns-go"

    - name: Send Telegram notification
      uses: appleboy/telegram-action@v1.0.0
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}  # ä½¿ç”¨åˆæ³•çš„Secretåç§°
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}  # ä½¿ç”¨åˆæ³•çš„Secretåç§°
        message: |
          ğŸš€ *ddns-go åŒæ­¥å®Œæˆ*
          - ä»“åº“: [13ztop/ddns-go](https://github.com/13ztop/ddns-go)
          - çŠ¶æ€: ${{ job.status }}
          - å˜æ›´: ${{ steps.check-changes.outputs.changes_detected == 'true' && 'æœ‰å˜æ›´ âœ…' || 'æ— å˜æ›´ âšª' }}
          - è§¦å‘æ–¹å¼: ${{ github.event_name == 'workflow_dispatch' && 'æ‰‹åŠ¨è§¦å‘' || 'å®šæ—¶è§¦å‘' }}
          - è¯¦ç»†æ—¥å¿—: [æŸ¥çœ‹æ—¥å¿—](https://github.com/13ztop/ddns-go/actions/runs/${{ github.run_id }})
        parse_mode: markdown

    - name: Cleanup
      run: rm -rf source-repo  # ä¿®æ­£ä¸ºæ­£ç¡®çš„å‘½ä»¤
