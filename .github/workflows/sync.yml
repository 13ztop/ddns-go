name: Full Sync ddns-go with Debugging

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è‡ªåŠ¨åŒæ­¥
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    - name: Debug: Print environment
      run: |
        echo "GitHub Repository: 13ztop/ddns-go"
        echo "Source Repository: 474706852/ddns-go"
        echo "Workflow Run ID: ${{ github.run_id }}"
        echo "Triggered by: ${{ github.event_name }}"
        echo "Runner OS: ${{ runner.os }}"

    - name: Checkout 13ztop/ddns-go
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.SYNC_TOKEN }}
        repository: 13ztop/ddns-go
        path: target-repo
        fetch-depth: 0
        ref: main
        persist-credentials: true  # ç¡®ä¿åç»­æ­¥éª¤ä½¿ç”¨ç›¸åŒå‡­è¯

    - name: Debug: List files after checkout
      run: |
        cd target-repo
        echo "å½“å‰ç›®å½•å†…å®¹:"
        ls -la
        echo "Git çŠ¶æ€:"
        git status
        echo "Git è¿œç¨‹ä¿¡æ¯:"
        git remote -v

    - name: Reset to origin/main
      run: |
        cd target-repo
        echo "é‡ç½®å‰ HEAD:"
        git log -1 --oneline
        git fetch origin
        git reset --hard origin/main
        echo "é‡ç½®å HEAD:"
        git log -1 --oneline
        echo "âœ… å·²é‡ç½®åˆ° origin/main"

    - name: Clone source ddns-go
      run: |
        git clone --depth 1 https://github.com/474706852/ddns-go.git source-repo
        cd source-repo
        git checkout main
        echo "æºä»“åº“ HEAD:"
        git log -1 --oneline

    - name: Perform full sync
      run: |
        echo "åŒæ­¥å‰ç›®æ ‡ä»“åº“å†…å®¹:"
        ls -la target-repo
        
        # ä¿ç•™ç›®æ ‡ä»“åº“çš„.gitç›®å½•
        find target-repo -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
        
        # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬éšè—æ–‡ä»¶ï¼‰
        cp -a source-repo/. target-repo/
        
        echo "åŒæ­¥åç›®æ ‡ä»“åº“å†…å®¹:"
        ls -la target-repo
        echo "âœ… æ‰€æœ‰æ–‡ä»¶å·²ä»æºä»“åº“åŒæ­¥"

    - name: Check for changes
      id: check-changes
      run: |
        cd target-repo
        echo "å˜æ›´æ£€æµ‹å‰çŠ¶æ€:"
        git status
        
        git add -A  # ç¡®ä¿æ‰€æœ‰æ›´æ”¹éƒ½è¢«æš‚å­˜
        
        # ä½¿ç”¨ git status æ£€æµ‹å˜æ›´
        if [ -z "$(git status --porcelain)" ]; then
          echo "ğŸŸ¢ æœªæ£€æµ‹åˆ°å˜æ›´"
          echo "changes_detected=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸŸ¡ æ£€æµ‹åˆ°å˜æ›´"
          echo "å˜æ›´å†…å®¹:"
          git diff --cached --name-status
          echo "changes_detected=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit changes
      if: steps.check-changes.outputs.changes_detected == 'true'
      run: |
        cd target-repo
        git config user.name "GitHub Actions Sync"
        git config user.email "actions@github.com"
        
        echo "æäº¤å‰çŠ¶æ€:"
        git status
        
        git add -A
        git commit -m "Auto-sync: Full update from 474706852/ddns-go @ $(date -u +'%Y-%m-%d %H:%M UTC')"
        
        echo "æäº¤åçŠ¶æ€:"
        git log -1 --oneline
        echo "ğŸ”µ å˜æ›´å·²æäº¤"

    - name: Force push changes
      if: steps.check-changes.outputs.changes_detected == 'true'
      run: |
        cd target-repo
        echo "æ¨é€å‰çŠ¶æ€:"
        git status
        git push origin main --force
        echo "ğŸš€ å˜æ›´å·²å¼ºåˆ¶æ¨é€åˆ° 13ztop/ddns-go"

    - name: Debug: Verify push
      if: steps.check-changes.outputs.changes_detected == 'true'
      run: |
        cd target-repo
        echo "æ¨é€åçŠ¶æ€:"
        git log -1 --oneline
        echo "è¿œç¨‹ä»“åº“çŠ¶æ€:"
        git ls-remote origin

    - name: Send Telegram notification (Simplified)
      env:
        BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # åŸºæœ¬æµ‹è¯•æ¶ˆæ¯
        MESSAGE="GitHub Sync: ddns-go åŒæ­¥æ“ä½œå®Œæˆã€‚çŠ¶æ€: ${{ job.status }}"
        
        # å‘é€è¯·æ±‚
        curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
          -d "chat_id=$CHAT_ID" \
          -d "text=$MESSAGE" \
          -o response.txt
        
        echo "Telegram API å“åº”:"
        cat response.txt
        
        if grep -q '"ok":true' response.txt; then
          echo "âœ… Telegram é€šçŸ¥å·²å‘é€"
        else
          echo "âŒ Telegram é€šçŸ¥å‘é€å¤±è´¥"
        fi

    - name: Cleanup
      run: rm -rf source-repo
